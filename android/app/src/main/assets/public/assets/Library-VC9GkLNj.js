import{r as a,u as le,s as n,j as e,B as re,S as oe,X as Y,P as ie,H as ne,M as ce,D as de}from"./index-2dP_p1EG.js";import{P as me}from"./plus-BwuWPFcm.js";import{S as z}from"./search-CwD-o-3E.js";import{S as J}from"./star-Ba8Tco0X.js";import{F as xe,a as R}from"./folder-DkKN_BlO.js";import{R as ue}from"./refresh-cw-efhXDZ7z.js";import{G as pe}from"./globe-CAKprFxp.js";import{L as he}from"./lock-R6dZoUXY.js";import{T as be}from"./tag-Bx5Zl2vv.js";import{T as fe}from"./trash-2-oGW_IUac.js";function ge({onNewPoem:B,onEditPoem:H}){const{user:o}=le(),[E,Q]=a.useState([]),[k,U]=a.useState([]),[b,W]=a.useState(""),[c,$]=a.useState("all"),[O,C]=a.useState(!1),[j,S]=a.useState(""),[d,Z]=a.useState(null),[y,X]=a.useState(null),[P,G]=a.useState({}),[m,I]=a.useState("library"),[w,F]=a.useState([]),[f,L]=a.useState(!1),[N,T]=a.useState(""),[g,A]=a.useState(""),x=a.useCallback(async()=>{if(!o)return;const{data:t,error:s}=await n.from("poems").select("*").eq("user_id",o.id).order("updated_at",{ascending:!1});if(s){console.error("Error loading poems:",s);return}const l=await Promise.allSettled((t||[]).map(async r=>{try{const{count:i}=await n.from("reactions").select("id",{count:"exact",head:!0}).eq("poem_id",r.id),{count:_}=await n.from("comments").select("id",{count:"exact",head:!0}).eq("poem_id",r.id);return{...r,like_count:i||0,comment_count:_||0}}catch{return{...r,like_count:0,comment_count:0}}})).then(r=>r.map(i=>i.status==="fulfilled"?i.value:null).filter(Boolean));Q(l)},[o]),v=a.useCallback(async()=>{if(!o)return;const{data:t,error:s}=await n.from("collections").select("*").eq("user_id",o.id).order("created_at",{ascending:!1});if(s){console.error("Error loading collections:",s);return}U(t||[])},[o]),u=a.useCallback(async()=>{if(!o)return;const{data:t,error:s}=await n.from("poem_collections").select("poem_id, collection_id");if(s){console.error("Error loading poem collections:",s);return}const l={};t==null||t.forEach(r=>{l[r.poem_id]||(l[r.poem_id]=[]),l[r.poem_id].push(r.collection_id)}),G(l)},[o]);a.useEffect(()=>{o&&(async()=>{try{await Promise.all([x(),v(),u()])}catch(s){console.error("Error loading library data:",s)}})()},[o,x,v,u]);const p=a.useCallback(async(t,s={})=>{if(o){L(!0);try{const r=`https://mablckeofkddwjgxhnbe.supabase.co/functions/v1/fetch-poems?${new URLSearchParams({action:t,...s})}`,i=await fetch(r,{headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hYmxja2VvZmtkZHdqZ3hobmJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNDUxNTQsImV4cCI6MjA4MTgyMTE1NH0.mO0bo8MtAF4RJUrCqQLYfz-BFbH8eUj5WmhCT2-hn-c","Content-Type":"application/json"}});if(!i.ok)throw new Error("Failed to fetch poems");const _=await i.json();F(_.poems||[])}catch(l){console.error("Error fetching internet poems:",l),F([])}finally{L(!1)}}},[o]),h=a.useCallback(()=>{p("random",{count:"20"})},[p]),D=a.useCallback(()=>{g?p("by_author",{author:g}):N?p("by_title",{title:N}):h()},[g,N,p,h]),K=a.useCallback(async t=>{if(!o)return;const s=t.lines.join(`
`),l=s.split(/\s+/).filter(i=>i.length>0).length,{error:r}=await n.from("poems").insert([{user_id:o.id,title:`${t.title} by ${t.author}`,content:s,is_public:!1,word_count:l,favorited:!1}]);if(r){console.error("Error saving poem:",r),alert("Failed to save poem");return}alert("Poem saved to your library!"),x()},[o,x]);a.useEffect(()=>{if(m==="discover"&&w.length===0&&!f){const t=setTimeout(()=>{h()},0);return()=>clearTimeout(t)}},[m,w.length,f,h]);const V=a.useCallback(async(t,s)=>{const{error:l}=await n.from("poem_collections").insert([{poem_id:t,collection_id:s}]);if(l){console.error("Error adding poem to collection:",l);return}u()},[u]),ee=a.useCallback(async(t,s)=>{const{error:l}=await n.from("poem_collections").delete().eq("poem_id",t).eq("collection_id",s);if(l){console.error("Error removing poem from collection:",l);return}u()},[u]),q=a.useMemo(()=>{let t=[...E];if(b){const s=b.toLowerCase();t=t.filter(l=>l.title.toLowerCase().includes(s)||l.content.toLowerCase().includes(s))}return c==="favorites"?t=t.filter(s=>s.favorited):c==="public"?t=t.filter(s=>s.is_public):c==="private"&&(t=t.filter(s=>!s.is_public)),d&&(t=t.filter(s=>{var l;return(l=P[s.id])==null?void 0:l.includes(d)})),t},[E,b,c,d,P]),te=a.useCallback(async t=>{if(!confirm("Are you sure you want to delete this poem?"))return;const{error:s}=await n.from("poems").delete().eq("id",t);if(s){console.error("Error deleting poem:",s);return}x()},[x]),M=a.useCallback(async()=>{if(!o||!j.trim())return;const{error:t}=await n.from("collections").insert([{user_id:o.id,name:j,description:"",color:"#6366f1"}]);if(t){console.error("Error creating collection:",t);return}S(""),C(!1),v()},[o,j,v]),se=a.useCallback(t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),[]),ae=["William Shakespeare","Emily Dickinson","Walt Whitman","Robert Frost","Maya Angelou","Langston Hughes","Edgar Allan Poe","Pablo Neruda","Sylvia Plath","T. S. Eliot","William Wordsworth","John Keats"];return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-4 sm:py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white",children:m==="library"?"Your Library":"Discover Poems"}),e.jsxs("button",{onClick:B,className:"flex items-center gap-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-colors",children:[e.jsx(me,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"New Poem"}),e.jsx("span",{className:"sm:hidden",children:"New"})]})]}),e.jsxs("div",{className:"flex gap-2 mb-6 border-b border-slate-200 dark:border-slate-700",children:[e.jsx("button",{onClick:()=>I("library"),className:`px-4 py-2 font-medium transition-colors border-b-2 ${m==="library"?"border-purple-500 text-purple-500":"border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{size:18}),"Your Poems"]})}),e.jsx("button",{onClick:()=>I("discover"),className:`px-4 py-2 font-medium transition-colors border-b-2 ${m==="discover"?"border-purple-500 text-purple-500":"border-transparent text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{size:18}),"Discover"]})})]}),m==="library"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("label",{htmlFor:"poem-search",className:"sr-only",children:"Search poems"}),e.jsx(z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:20,"aria-hidden":"true"}),e.jsx("input",{id:"poem-search",type:"search",value:b,onChange:t=>W(t.target.value),placeholder:"Search poems...",className:"w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white","aria-label":"Search poems by title or content"})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto",role:"group","aria-label":"Filter poems",children:[e.jsx("button",{onClick:()=>$("all"),className:`px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors text-sm whitespace-nowrap ${c==="all"?"bg-purple-500 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400"}`,"aria-pressed":c==="all","aria-label":"Show all poems",children:"All"}),e.jsxs("button",{onClick:()=>$("favorites"),className:`px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-1.5 text-sm whitespace-nowrap ${c==="favorites"?"bg-purple-500 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400"}`,"aria-pressed":c==="favorites","aria-label":"Show favorite poems only",children:[e.jsx(J,{size:16,"aria-hidden":"true"}),e.jsx("span",{className:"hidden xs:inline",children:"Favorites"})]})]})]}),e.jsxs("div",{className:"flex gap-2 mb-6 overflow-x-auto pb-2",role:"group","aria-label":"Collections",children:[e.jsxs("button",{onClick:()=>C(!0),className:"flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors whitespace-nowrap","aria-label":"Create new collection",children:[e.jsx(xe,{size:18,"aria-hidden":"true"}),e.jsx("span",{className:"text-sm font-medium",children:"New Collection"})]}),k.map(t=>e.jsxs("button",{onClick:()=>Z(d===t.id?null:t.id),className:`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors whitespace-nowrap ${d===t.id?"bg-purple-500 text-white":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400"}`,"aria-pressed":d===t.id,"aria-label":`${d===t.id?"Hide":"Show"} collection: ${t.name}`,children:[e.jsx(R,{size:18,"aria-hidden":"true"}),e.jsx("span",{className:"text-sm font-medium",children:t.name})]},t.id))]}),O&&e.jsx("div",{className:"mb-6 p-4 bg-slate-100 dark:bg-slate-800 rounded-lg",role:"form","aria-label":"Create new collection",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"new-collection-name",className:"sr-only",children:"Collection name"}),e.jsx("input",{id:"new-collection-name",type:"text",value:j,onChange:t=>S(t.target.value),placeholder:"Collection name...",className:"flex-1 px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white",onKeyDown:t=>t.key==="Enter"&&M(),"aria-label":"New collection name"}),e.jsx("button",{onClick:M,className:"px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium","aria-label":"Create collection",children:"Create"}),e.jsx("button",{onClick:()=>{C(!1),S("")},className:"px-3 py-2 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400 rounded-lg","aria-label":"Cancel creating collection",children:e.jsx(Y,{size:20,"aria-hidden":"true"})})]})})]}):e.jsxs("div",{className:"space-y-6 mb-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:20}),e.jsx("input",{type:"search",value:N,onChange:t=>T(t.target.value),placeholder:"Search by title...",className:"w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white",onKeyDown:t=>t.key==="Enter"&&D()})]}),e.jsxs("button",{onClick:D,disabled:f,className:"px-4 py-2 bg-cyan-500 hover:bg-cyan-600 disabled:bg-slate-400 text-white rounded-lg font-medium transition-colors flex items-center gap-2",children:[e.jsx(z,{size:18}),"Search"]}),e.jsxs("button",{onClick:h,disabled:f,className:"px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-slate-400 text-white rounded-lg font-medium transition-colors flex items-center gap-2",children:[e.jsx(ue,{size:18}),"Random"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 mb-3",children:"Popular Authors:"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:ae.map(t=>e.jsx("button",{onClick:()=>{A(t),T(""),p("by_author",{author:t})},className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${g===t?"bg-purple-500 text-white":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"}`,children:t},t))}),g&&e.jsxs("button",{onClick:()=>{A(""),h()},className:"mt-3 text-sm text-purple-500 hover:text-purple-600 flex items-center gap-1",children:[e.jsx(Y,{size:14}),"Clear author filter"]})]})]})]}),m==="library"?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",role:"list","aria-label":"Poem library",children:q.length===0?e.jsx("div",{className:"col-span-full text-center py-12",role:"status",children:e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:b||c!=="all"?"No poems found matching your criteria":"No poems yet. Start writing!"})}):q.map(t=>e.jsxs("article",{className:"bg-white dark:bg-slate-800 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow group relative",role:"listitem","aria-label":`Poem: ${t.title}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white line-clamp-1 flex-1",children:t.title}),e.jsxs("div",{className:"flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity",role:"group","aria-label":"Poem actions",children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),H(t.id)},className:"text-purple-500 hover:text-purple-600","aria-label":`Edit ${t.title}`,children:e.jsx(ie,{size:16,"aria-hidden":"true"})}),t.favorited&&e.jsx(J,{size:16,className:"text-yellow-500",fill:"currentColor","aria-label":"Favorited"}),t.is_public?e.jsx(pe,{size:16,className:"text-green-500","aria-label":"Public poem"}):e.jsx(he,{size:16,className:"text-slate-400","aria-label":"Private poem"}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),X(y===t.id?null:t.id)},className:"text-slate-500 hover:text-slate-700 dark:hover:text-slate-300","aria-label":`${y===t.id?"Close":"Open"} collection menu for ${t.title}`,"aria-expanded":y===t.id,"aria-haspopup":"menu",children:e.jsx(be,{size:16,"aria-hidden":"true"})}),y===t.id&&e.jsx("div",{className:"absolute right-0 mt-2 w-48 bg-white dark:bg-slate-700 rounded-lg shadow-lg border border-slate-200 dark:border-slate-600 z-10",role:"menu","aria-label":"Collection menu",children:e.jsxs("div",{className:"p-2",children:[e.jsx("p",{className:"text-xs font-medium text-slate-500 dark:text-slate-400 px-2 py-1",children:"Add to Collection"}),k.length===0?e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 px-2 py-2",children:"No collections yet"}):k.map(s=>{var r;const l=(r=P[t.id])==null?void 0:r.includes(s.id);return e.jsx("button",{onClick:i=>{i.stopPropagation(),l?ee(t.id,s.id):V(t.id,s.id)},className:`w-full text-left px-2 py-1.5 rounded text-sm transition-colors ${l?"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300":"hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300"}`,role:"menuitem","aria-label":`${l?"Remove from":"Add to"} collection: ${s.name}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{size:14,"aria-hidden":"true"}),e.jsx("span",{children:s.name})]})},s.id)})]})})]}),e.jsx("button",{onClick:s=>{s.stopPropagation(),te(t.id)},className:"text-red-500 hover:text-red-600","aria-label":`Delete ${t.title}`,children:e.jsx(fe,{size:16,"aria-hidden":"true"})})]})]}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400 text-sm line-clamp-3 mb-4 font-serif",children:t.content||"No content yet..."}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ne,{size:14,"aria-hidden":"true"}),t.like_count||0]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{size:14,"aria-hidden":"true"}),t.comment_count||0]})]}),e.jsxs("span",{children:[t.word_count," words"]})]}),e.jsx("div",{className:"text-xs text-slate-500",children:e.jsx("span",{children:se(t.created_at)})})]},t.id))}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:f?e.jsxs("div",{className:"col-span-full text-center py-12",children:[e.jsx("div",{className:"inline-flex items-center justify-center",children:e.jsx("div",{className:"text-6xl animate-walk",children:"ðŸ¦"})}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 mt-4",children:"Loading poems..."}),e.jsx("style",{children:`
                @keyframes walk {
                  0%, 100% { transform: translateY(0px) rotate(-5deg); }
                  25% { transform: translateY(-8px) rotate(0deg); }
                  50% { transform: translateY(0px) rotate(5deg); }
                  75% { transform: translateY(-8px) rotate(0deg); }
                }
                .animate-walk {
                  animation: walk 0.6s ease-in-out infinite;
                }
              `})]}):w.length===0?e.jsx("div",{className:"col-span-full text-center py-12",children:e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:"No poems found. Try searching or loading random poems."})}):w.map((t,s)=>e.jsxs("article",{className:"bg-white dark:bg-slate-800 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow group",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white line-clamp-2",children:t.title}),e.jsxs("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:["by ",t.author]})]}),e.jsx("button",{onClick:()=>K(t),className:"text-cyan-500 hover:text-cyan-600 opacity-0 group-hover:opacity-100 transition-opacity",title:"Save to your library",children:e.jsx(de,{size:18})})]}),e.jsxs("p",{className:"text-slate-600 dark:text-slate-400 text-sm line-clamp-6 mb-4 font-serif whitespace-pre-wrap",children:[t.lines.slice(0,8).join(`
`),t.lines.length>8&&`
...`]}),e.jsx("div",{className:"flex items-center justify-between text-xs text-slate-500",children:e.jsxs("span",{children:[t.linecount," lines"]})})]},`${t.author}-${t.title}-${s}`))})]})}const ze=a.memo(ge);export{ze as default};
