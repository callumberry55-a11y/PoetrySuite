import{u as L,r as c,s as o,j as e,M as A,B as M,l as q,T as U,i as H,m as G,H as $,X as J,g as F}from"./index-2dP_p1EG.js";import{r as W}from"./security-CwStJ5w9.js";import{T as Y}from"./trash-2-oGW_IUac.js";import{S as O}from"./send-CguWdOWq.js";import{U as R}from"./user-check-GSo7_DJH.js";import{B as V,a as X}from"./bookmark-plus-DybcFlbK.js";import"./index.esm-hzf3Ma5u.js";function K({poemId:a}){const{user:d}=L(),[h,_]=c.useState([]),[w,C]=c.useState(""),[j,m]=c.useState(!0),[y,n]=c.useState(!1),v=c.useCallback(async()=>{try{m(!0);const{data:i,error:l}=await o.from("comments").select(`
          id,
          poem_id,
          user_id,
          content,
          created_at,
          updated_at
        `).eq("poem_id",a).order("created_at",{ascending:!0});if(l)throw l;const p=await Promise.all((i||[]).map(async f=>{const{data:u}=await o.from("user_profiles").select("username").eq("user_id",f.user_id).maybeSingle();return{...f,username:(u==null?void 0:u.username)||"Anonymous"}}));_(p)}catch(i){console.error("Error loading comments:",i)}finally{m(!1)}},[a]);c.useEffect(()=>{v()},[v]);const z=async i=>{if(i.preventDefault(),!w.trim()||!d)return;const l=w.trim();C("");try{n(!0);const{data:p,error:f}=await o.from("comments").insert({poem_id:a,user_id:d.id,content:l}).select().single();if(f)throw f;const{data:u}=await o.from("user_profiles").select("username").eq("user_id",d.id).maybeSingle(),N={...p,username:(u==null?void 0:u.username)||"Anonymous"};_([...h,N])}catch(p){console.error("Error posting comment:",p),C(l),alert("Failed to post comment. Please try again.")}finally{n(!1)}},S=async i=>{if(confirm("Delete this comment?"))try{const{error:l}=await o.from("comments").delete().eq("id",i);if(l)throw l;_(h.filter(p=>p.id!==i))}catch(l){console.error("Error deleting comment:",l),alert("Failed to delete comment")}},k=i=>{const l=new Date(i),f=new Date().getTime()-l.getTime(),u=Math.floor(f/6e4),N=Math.floor(f/36e5),s=Math.floor(f/864e5);return u<1?"Just now":u<60?`${u}m ago`:N<24?`${N}h ago`:s<7?`${s}d ago`:l.toLocaleDateString()};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-on-surface-variant",children:[e.jsx(A,{size:20}),e.jsxs("h3",{className:"font-semibold",children:["Comments (",h.length,")"]})]}),j?e.jsx("div",{className:"text-center py-8 text-on-surface-variant",children:"Loading comments..."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:h.length===0?e.jsx("p",{className:"text-center py-8 text-on-surface-variant",children:"No comments yet. Be the first to comment!"}):h.map(i=>e.jsx("div",{className:"bg-surface-variant rounded-lg p-3 space-y-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-semibold text-on-surface",children:i.username}),e.jsx("span",{className:"text-on-surface-variant text-xs",children:k(i.created_at)})]}),e.jsx("p",{className:"text-on-surface mt-1 whitespace-pre-wrap break-words",children:i.content})]}),d&&d.id===i.user_id&&e.jsx("button",{onClick:()=>S(i.id),className:"flex-shrink-0 p-1.5 rounded-lg hover:bg-error-container hover:text-error transition-colors","aria-label":"Delete comment",children:e.jsx(Y,{size:16})})]})},i.id))}),d&&e.jsxs("form",{onSubmit:z,className:"space-y-3",children:[e.jsx("textarea",{value:w,onChange:i=>C(i.target.value),placeholder:"Write a comment...",className:"w-full px-4 py-3 bg-surface-variant text-on-surface rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary",rows:3,maxLength:500}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-on-surface-variant",children:[w.length,"/500"]}),e.jsxs("button",{type:"submit",disabled:!w.trim()||y,className:"flex items-center gap-2 px-4 py-2 bg-primary text-on-primary rounded-lg font-medium hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[e.jsx(O,{size:16}),y?"Posting...":"Post Comment"]})]})]})]})]})}function re(){const{user:a}=L(),[d,h]=c.useState([]),[_,w]=c.useState([]),[C,j]=c.useState(!0),[m,y]=c.useState("feed"),[n,v]=c.useState(null),[z,S]=c.useState("checking"),k=c.useCallback(async()=>{j(!0);try{let s=o.from("poems").select("id, title, content, user_id, created_at").eq("is_public",!0).order("created_at",{ascending:!1}).limit(50);if(m==="following"&&a){const{data:t}=await o.from("follows").select("following_id").eq("follower_id",a.id),g=(t==null?void 0:t.map(D=>D.following_id))||[];if(g.length===0){h([]),j(!1);return}s=s.in("user_id",g)}const{data:r,error:x}=await s;if(x)throw x;const b=await Promise.all((r||[]).map(async t=>{const{data:g}=await o.from("user_profiles").select("username").eq("user_id",t.user_id).maybeSingle(),{count:D}=await o.from("reactions").select("id",{count:"exact",head:!0}).eq("poem_id",t.id),{count:P}=await o.from("comments").select("id",{count:"exact",head:!0}).eq("poem_id",t.id),{data:T}=a?await o.from("reactions").select("id").eq("poem_id",t.id).eq("user_id",a.id).maybeSingle():{data:null},{data:E}=a?await o.from("bookmarks").select("id").eq("poem_id",t.id).eq("user_id",a.id).maybeSingle():{data:null},{data:B}=a?await o.from("follows").select("id").eq("follower_id",a.id).eq("following_id",t.user_id).maybeSingle():{data:null};return{id:t.id,title:t.title,content:t.content,created_at:t.created_at,user_id:t.user_id,username:(g==null?void 0:g.username)||"Anonymous",like_count:D||0,comment_count:P||0,user_has_liked:!!T,user_has_bookmarked:!!E,user_is_following:!!B}}));h(b)}catch(s){console.error("Failed to load feed:",s)}finally{j(!1)}},[m,a]),i=c.useCallback(async()=>{j(!0);try{const{data:s,error:r}=await o.from("contests").select("*").order("start_date",{ascending:!1});if(r)throw r;w(s||[])}catch(s){console.error("Failed to load contests:",s)}finally{j(!1)}},[]);c.useEffect(()=>{m==="contests"?i():k()},[m,a,i,k]),c.useEffect(()=>{const s=async()=>{S("checking");const x=await W("some-user-input");S(x?"active":"inactive")};s();const r=setInterval(s,5e3);return()=>clearInterval(r)},[]);const l=async s=>{if(!a){alert("Please sign in to like poems");return}const r=d.find(t=>t.id===s);if(!r)return;const x=r.user_has_liked,b=r.like_count;h(d.map(t=>t.id===s?{...t,user_has_liked:!t.user_has_liked,like_count:t.like_count+(t.user_has_liked?-1:1)}:t)),(n==null?void 0:n.id)===s&&v({...n,user_has_liked:!n.user_has_liked,like_count:n.like_count+(n.user_has_liked?-1:1)});try{if(x){const{error:t}=await o.from("reactions").delete().eq("poem_id",s).eq("user_id",a.id);if(t)throw t}else{const{error:t}=await o.from("reactions").insert([{poem_id:s,user_id:a.id}]);if(t)throw t}}catch(t){console.error("Error toggling like:",t),h(d.map(g=>g.id===s?{...g,user_has_liked:x,like_count:b}:g)),(n==null?void 0:n.id)===s&&v({...n,user_has_liked:x,like_count:b}),alert("Failed to update like. Please try again.")}},p=async s=>{if(!a)return;const r=d.find(x=>x.id===s);r&&(r.user_has_bookmarked?await o.from("bookmarks").delete().eq("poem_id",s).eq("user_id",a.id):await o.from("bookmarks").insert([{poem_id:s,user_id:a.id}]),k())},f=async s=>{if(!a||s===a.id)return;const r=d.find(x=>x.user_id===s);r&&(r.user_is_following?await o.from("follows").delete().eq("follower_id",a.id).eq("following_id",s):await o.from("follows").insert([{follower_id:a.id,following_id:s}]),k())},u=s=>{const r=new Date(s),b=Math.floor((new Date().getTime()-r.getTime())/(1e3*60*60));return b<1?"Just now":b<24?`${b}h ago`:b<48?"Yesterday":r.toLocaleDateString("en-US",{month:"short",day:"numeric"})},N=()=>{switch(z){case"active":return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600 dark:text-green-400",children:[e.jsx(F,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"AI Security Guard: Active"}),e.jsx("span",{className:"sm:hidden",children:"Security Active"})]});case"inactive":return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600 dark:text-red-400",children:[e.jsx(F,{size:18}),e.jsx("span",{className:"hidden sm:inline",children:"AI Security Guard: Inactive"}),e.jsx("span",{className:"sm:hidden",children:"Security Inactive"})]});case"checking":return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-yellow-600 dark:text-yellow-400",children:[e.jsx(F,{size:18,className:"animate-pulse"}),e.jsx("span",{className:"hidden sm:inline",children:"AI Security Guard: Checking..."}),e.jsx("span",{className:"sm:hidden",children:"Checking..."})]});default:return null}};return e.jsxs("div",{className:"w-full h-full flex flex-col bg-gradient-to-br from-background to-secondary-container/20",children:[e.jsxs("div",{className:"p-4 sm:p-6 border-b border-outline",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 sm:mb-6",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-on-background",children:"Poetry Feed"}),N()]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2 hide-scrollbar",children:[e.jsxs("button",{onClick:()=>y("feed"),className:`flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors text-sm sm:text-base ${m==="feed"?"bg-primary text-on-primary":"bg-surface text-on-surface-variant hover:bg-surface-variant"}`,children:[e.jsx(M,{size:18}),"Feed"]}),e.jsxs("button",{onClick:()=>y("contests"),className:`flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors text-sm sm:text-base ${m==="contests"?"bg-primary text-on-primary":"bg-surface text-on-surface-variant hover:bg-surface-variant"}`,children:[e.jsx(q,{size:18}),"Contests"]}),e.jsxs("button",{onClick:()=>y("trending"),className:`flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors text-sm sm:text-base ${m==="trending"?"bg-primary text-on-primary":"bg-surface text-on-surface-variant hover:bg-surface-variant"}`,children:[e.jsx(U,{size:18}),"Trending"]}),e.jsxs("button",{onClick:()=>y("following"),className:`flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors text-sm sm:text-base ${m==="following"?"bg-primary text-on-primary":"bg-surface text-on-surface-variant hover:bg-surface-variant"}`,children:[e.jsx(H,{size:18}),"Following"]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6",children:[C?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"})}):m==="contests"?e.jsxs("div",{className:"max-w-4xl mx-auto space-y-4 sm:space-y-6",children:[_.map(s=>{const r=s.status==="active"?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300":s.status==="voting"?"bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300":"bg-slate-100 text-slate-700 dark:bg-slate-900/30 dark:text-slate-300";return e.jsx("div",{className:"bg-surface rounded-xl shadow-sm border border-outline overflow-hidden hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(q,{className:"text-tertiary flex-shrink-0",size:24}),e.jsx("h3",{className:"text-xl sm:text-2xl font-bold text-on-surface",children:s.title})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${r}`,children:s.status}),e.jsx("span",{className:"px-3 py-1 rounded-full text-sm font-medium bg-tertiary-container text-on-tertiary-container",children:s.theme})]})]})}),e.jsx("p",{className:"text-on-surface-variant mb-4 leading-relaxed text-sm sm:text-base",children:s.description}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6 text-xs sm:text-sm text-on-surface-variant mb-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Submissions:"})," ",new Date(s.start_date).toLocaleDateString()," - ",new Date(s.end_date).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Voting ends:"})," ",new Date(s.voting_end_date).toLocaleDateString()]})]}),s.status==="active"&&e.jsxs("button",{className:"w-full mt-4 px-4 py-3 bg-primary hover:bg-primary/90 text-on-primary rounded-lg font-medium transition-colors flex items-center justify-center gap-2",children:[e.jsx(q,{size:18}),"Submit Your Poem"]})]})},s.id)}),_.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(q,{className:"mx-auto mb-4 text-on-surface-variant",size:48}),e.jsx("p",{className:"text-on-surface-variant",children:"No contests available"})]})]}):e.jsx("div",{className:"max-w-3xl mx-auto space-y-4 sm:space-y-6 pb-20",children:d.length===0?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-on-surface-variant",children:m==="following"?"Follow some poets to see their work here":"No poems to display yet"})}):d.map(s=>e.jsxs("article",{className:"bg-surface rounded-xl shadow-sm border border-outline overflow-hidden hover:shadow-md transition-all",children:[e.jsxs("div",{className:"p-4 sm:p-6 cursor-pointer",onClick:()=>v(s),children:[e.jsxs("div",{className:"flex items-center justify-between mb-3 sm:mb-4 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 min-w-0 flex-1",children:[e.jsx("div",{className:"w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-primary flex items-center justify-center text-on-primary font-semibold flex-shrink-0 text-sm sm:text-base",children:s.username.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"font-semibold text-on-surface text-sm sm:text-base truncate",children:s.username}),e.jsx("div",{className:"text-xs text-on-surface-variant",children:u(s.created_at)})]})]}),s.user_id!==(a==null?void 0:a.id)&&e.jsx("button",{onClick:r=>{r.stopPropagation(),f(s.user_id)},className:`flex items-center gap-1.5 px-2.5 sm:px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-colors touch-manipulation flex-shrink-0 ${s.user_is_following?"bg-surface-variant text-on-surface-variant":"bg-primary text-on-primary hover:bg-primary/90"}`,children:s.user_is_following?e.jsxs(e.Fragment,{children:[e.jsx(R,{size:12,className:"sm:w-[14px] sm:h-[14px]"}),e.jsx("span",{className:"hidden sm:inline",children:"Following"})]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{size:12,className:"sm:w-[14px] sm:h-[14px]"}),e.jsx("span",{className:"hidden sm:inline",children:"Follow"})]})})]}),e.jsx("h3",{className:"text-lg sm:text-xl font-bold text-on-surface mb-2",children:s.title}),e.jsx("div",{className:"prose dark:prose-invert max-w-none mb-4",children:e.jsx("p",{className:"whitespace-pre-wrap line-clamp-6 text-sm sm:text-base text-on-surface-variant",children:s.content})})]}),e.jsxs("div",{className:"px-4 sm:px-6 pb-4 flex items-center gap-3 sm:gap-4 border-t border-outline pt-3",children:[e.jsxs("button",{onClick:r=>{r.stopPropagation(),l(s.id)},className:`flex items-center gap-1.5 sm:gap-2 px-3 py-1.5 rounded-lg transition-all ${s.user_has_liked?"text-red-500 bg-red-50 dark:bg-red-950/20 hover:bg-red-100 dark:hover:bg-red-950/30":"text-on-surface-variant hover:bg-surface-variant hover:text-red-500"}`,children:[e.jsx($,{size:16,className:`sm:w-[18px] sm:h-[18px] transition-all ${s.user_has_liked?"scale-110":""}`,fill:s.user_has_liked?"currentColor":"none"}),e.jsx("span",{className:"text-xs sm:text-sm font-medium",children:s.like_count})]}),e.jsxs("button",{onClick:()=>v(s),className:"flex items-center gap-1.5 sm:gap-2 px-3 py-1.5 rounded-lg text-on-surface-variant hover:bg-surface-variant transition-colors",children:[e.jsx(A,{size:16,className:"sm:w-[18px] sm:h-[18px]"}),e.jsx("span",{className:"text-xs sm:text-sm font-medium",children:s.comment_count})]}),e.jsx("button",{onClick:r=>{r.stopPropagation(),p(s.id)},className:`flex items-center gap-1.5 sm:gap-2 transition-colors ml-auto touch-manipulation px-3 py-1.5 rounded-lg ${s.user_has_bookmarked?"text-primary hover:bg-primary/10":"text-on-surface-variant hover:bg-surface-variant"}`,children:s.user_has_bookmarked?e.jsx(V,{size:16,className:"sm:w-[18px] sm:h-[18px]",fill:"currentColor"}):e.jsx(X,{size:16,className:"sm:w-[18px] sm:h-[18px]"})})]})]},s.id))}),n&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto",children:e.jsxs("div",{className:"bg-surface rounded-2xl shadow-2xl max-w-2xl w-full my-8",children:[e.jsxs("div",{className:"flex items-start justify-between p-4 sm:p-6 border-b border-outline",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-on-surface",children:n.title}),e.jsxs("p",{className:"text-on-surface-variant mt-1 text-sm sm:text-base",children:["by ",n.username||"Anonymous"]})]}),e.jsx("button",{onClick:()=>v(null),className:"text-on-surface-variant hover:text-on-surface","aria-label":"Close",children:e.jsx(J,{size:24})})]}),e.jsxs("div",{className:"p-4 sm:p-6 max-h-[60vh] overflow-y-auto",children:[e.jsx("div",{className:"prose dark:prose-invert max-w-none mb-6",children:e.jsx("p",{className:"whitespace-pre-wrap text-on-surface",children:n.content})}),e.jsx("div",{className:"flex items-center gap-4 pb-6 mb-6 border-b border-outline",children:e.jsxs("button",{onClick:()=>l(n.id),className:`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${n.user_has_liked?"bg-red-50 text-red-500 dark:bg-red-950/20 hover:bg-red-100 dark:hover:bg-red-950/30":"bg-surface-variant text-on-surface-variant hover:bg-on-surface-variant/10 hover:text-red-500"}`,children:[e.jsx($,{size:18,className:`transition-all ${n.user_has_liked?"scale-110":""}`,fill:n.user_has_liked?"currentColor":"none"}),e.jsxs("span",{children:[n.like_count||0," ",(n.like_count||0)===1?"Like":"Likes"]})]})}),e.jsx(K,{poemId:n.id})]})]})})]})]})}export{re as default};
