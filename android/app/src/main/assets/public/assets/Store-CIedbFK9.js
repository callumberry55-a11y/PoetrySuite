import{u as Z,r as o,s as d,j as e,Q as H,S as Q,Z as U,A as W}from"./index-2dP_p1EG.js";import{C as N}from"./coins-XiO7lNo2.js";import{T as E}from"./tag-Bx5Zl2vv.js";import{D as G}from"./dollar-sign-ICVN2oor.js";import{P as L,C as T,a as J,b as K}from"./palette-RYOaxoOC.js";import{C as V}from"./clock-DJOLL9Lo.js";import{L as A}from"./lock-R6dZoUXY.js";function ne(){var C,z,P;const{user:s}=Z(),[g,I]=o.useState([]),[a,$]=o.useState(null),[m,O]=o.useState(null),[q,_]=o.useState(!0),[j,k]=o.useState(null),[v,F]=o.useState("all"),h=o.useCallback(async()=>{if(!s)return;const{data:t,error:r}=await d.from("user_profiles").select("points_balance, points_earned_total").eq("user_id",s.id).maybeSingle();if(r){console.error("Error loading profile:",r);return}$(t)},[s]),b=o.useCallback(async()=>{if(!s)return;const{data:t,error:r}=await d.from("store_items").select("*").eq("is_active",!0).order("price",{ascending:!0});if(r){console.error("Error loading store items:",r),_(!1);return}const{data:l,error:c}=await d.from("user_purchases").select("item_id").eq("user_id",s.id);c&&console.error("Error loading purchases:",c);const p=new Set((l==null?void 0:l.map(x=>x.item_id))||[]),u=(t||[]).map(x=>({...x,owned:p.has(x.id)}));I(u),_(!1)},[s]),y=o.useCallback(async()=>{const{data:t}=await d.from("tax_settings").select("purchase_tax_rate").eq("is_active",!0).order("created_at",{ascending:!1}).limit(1).maybeSingle();t&&O(t)},[]);o.useEffect(()=>{s&&(b(),h(),y());const t=d.channel("store_items_realtime").on("postgres_changes",{event:"*",schema:"public",table:"store_items"},()=>{b()}).subscribe(),r=d.channel("user_profiles_store_realtime").on("postgres_changes",{event:"UPDATE",schema:"public",table:"user_profiles",filter:s?`user_id=eq.${s.id}`:void 0},()=>{h()}).subscribe();return()=>{d.removeChannel(t),d.removeChannel(r)}},[s,b,h,y]);const M=async(t,r)=>{if(!s||!a)return;if(a.points_balance<r){alert("Not enough points!");return}k(t);const{data:l,error:c}=await d.rpc("purchase_store_item",{p_user_id:s.id,p_item_id:t});c?(console.error("Error purchasing item:",c),alert("Failed to purchase item. Please try again.")):l&&!l.success?alert(l.error||"Failed to purchase item"):(await b(),await h()),k(null)},B=t=>{switch(t){case"badge":return W;case"theme":return K;case"title":return J;case"boost":return U;case"feature":return Q;default:return L}},R=t=>{switch(t){case"badge":return"from-purple-400 to-violet-600";case"theme":return"from-cyan-400 to-sky-500";case"title":return"from-violet-500 to-purple-600";case"boost":return"from-sky-400 to-cyan-500";case"feature":return"from-violet-400 to-purple-500";default:return"from-slate-400 to-slate-600"}},S=g.filter(t=>v==="all"||t.category===v),Y=[{id:"all",label:"All Items"},{id:"badge",label:"Badges"},{id:"theme",label:"Themes"},{id:"title",label:"Titles"},{id:"boost",label:"Boosts"},{id:"feature",label:"Features"}];return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-4 sm:py-8 pb-24",children:[e.jsxs("div",{className:"mb-4 sm:mb-6",children:[e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-slate-900 dark:text-white mb-1 sm:mb-2 flex items-center gap-2",children:[e.jsx(H,{size:24}),"Points Store"]}),e.jsx("p",{className:"text-sm sm:text-base text-slate-600 dark:text-slate-400",children:"Spend your earned points on exclusive items and features"})]}),e.jsx("div",{className:"bg-gradient-to-br from-purple-500 via-violet-500 to-purple-600 rounded-lg p-4 sm:p-6 mb-6 text-white shadow-lg",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(N,{size:24}),e.jsx("h3",{className:"text-lg sm:text-xl font-bold",children:"Your Points"})]}),e.jsx("p",{className:"text-purple-100 text-sm",children:"Earned from badges and activities"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-3xl sm:text-4xl font-bold",children:((C=a==null?void 0:a.points_balance)==null?void 0:C.toLocaleString())||0}),e.jsxs("div",{className:"text-purple-100 text-sm",children:[((z=a==null?void 0:a.points_earned_total)==null?void 0:z.toLocaleString())||0," total earned"]})]})]})}),g.some(t=>t.discount_percentage&&t.discount_percentage>0&&t.sale_ends_at&&new Date(t.sale_ends_at)>new Date)&&e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 via-violet-500 to-purple-600 rounded-lg p-6 mb-6 text-white shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(E,{size:32,className:"flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold",children:"Monthly Sale Event!"}),e.jsx("p",{className:"text-purple-100",children:"Huge discounts on selected items - Limited time only!"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4",children:[e.jsxs("div",{className:"bg-white/20 backdrop-blur-sm rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-3xl font-bold",children:"75%"}),e.jsx("div",{className:"text-xs text-purple-100",children:"Max Discount"})]}),e.jsxs("div",{className:"bg-white/20 backdrop-blur-sm rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-3xl font-bold",children:g.filter(t=>t.discount_percentage&&t.discount_percentage>0&&t.sale_ends_at&&new Date(t.sale_ends_at)>new Date).length}),e.jsx("div",{className:"text-xs text-purple-100",children:"Items on Sale"})]}),e.jsxs("div",{className:"bg-white/20 backdrop-blur-sm rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-3xl font-bold",children:Math.ceil((new Date(((P=g.find(t=>t.sale_ends_at))==null?void 0:P.sale_ends_at)||new Date).getTime()-new Date().getTime())/(1e3*60*60*24))}),e.jsx("div",{className:"text-xs text-purple-100",children:"Days Left"})]}),e.jsxs("div",{className:"bg-white/20 backdrop-blur-sm rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Save Big"}),e.jsx("div",{className:"text-xs text-purple-100",children:"Limited Stock"})]})]})]}),m&&m.purchase_tax_rate>0&&e.jsx("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(G,{className:"text-amber-600 dark:text-amber-400 flex-shrink-0 mt-0.5",size:20}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-amber-900 dark:text-amber-100 mb-1",children:"Purchase Tax Applied"}),e.jsxs("p",{className:"text-sm text-amber-700 dark:text-amber-300",children:["A ",m.purchase_tax_rate,"% tax is applied to all purchases. Your tax points are split equally: 50% rewards PaaS developers who build features for the community, and 50% goes to the reserve fund for economic stability."]})]})]})}),e.jsx("div",{className:"mb-6 flex gap-2 overflow-x-auto pb-2",children:Y.map(t=>e.jsx("button",{onClick:()=>F(t.id),className:`px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition-colors whitespace-nowrap ${v===t.id?"bg-gradient-to-r from-purple-500 to-violet-500 text-white shadow-md":"bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"}`,children:t.label},t.id))}),q?e.jsx("div",{className:"text-center py-12",children:e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"})}):S.length===0?e.jsxs("div",{className:"text-center py-12 bg-white dark:bg-slate-800 rounded-lg",children:[e.jsx(L,{className:"mx-auto mb-3 text-slate-400",size:48}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:"No items found in this category"})]}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:S.map(t=>{const r=B(t.category),l=(m==null?void 0:m.purchase_tax_rate)||1.5,c=Math.ceil(t.price*(l/100)),p=t.price+c,u=((a==null?void 0:a.points_balance)||0)>=p,x=t.stock===0,n=t.discount_percentage&&t.discount_percentage>0&&t.sale_ends_at,f=t.sale_ends_at?new Date(t.sale_ends_at):null,D=new Date,i=f&&f>D,w=f?Math.ceil((f.getTime()-D.getTime())/(1e3*60*60*24)):0;return e.jsxs("div",{className:`bg-white dark:bg-slate-800 rounded-lg shadow-sm p-4 sm:p-6 relative overflow-hidden ${t.owned?"ring-2 ring-green-500":""} ${n&&i?"ring-2 ring-purple-500":""}`,children:[t.owned&&e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx("div",{className:"bg-green-500 text-white rounded-full p-1",children:e.jsx(T,{size:16})})}),n&&i&&!t.owned&&e.jsx("div",{className:"absolute top-3 left-3 z-10",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-violet-500 text-white px-3 py-1 rounded-full flex items-center gap-1 shadow-lg animate-pulse",children:[e.jsx(E,{size:14}),e.jsxs("span",{className:"font-bold text-sm",children:[t.discount_percentage,"% OFF"]})]})}),e.jsx("div",{className:`w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gradient-to-br ${R(t.category)} flex items-center justify-center mx-auto mb-4 ${n&&i?"ring-4 ring-purple-500/30":""}`,children:e.jsx(r,{className:"text-white",size:32})}),e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("h3",{className:"font-bold text-base sm:text-lg text-slate-900 dark:text-white mb-2",children:t.name}),e.jsx("p",{className:"text-xs sm:text-sm text-slate-600 dark:text-slate-400 mb-3",children:t.description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[n&&i&&t.original_price&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-2 py-1 bg-slate-100 dark:bg-slate-700/50 rounded-full",children:[e.jsx(N,{size:12,className:"text-slate-400"}),e.jsx("span",{className:"text-sm line-through text-slate-400 dark:text-slate-500",children:t.original_price.toLocaleString()})]}),e.jsxs("div",{className:`inline-flex items-center gap-1 px-3 py-1 rounded-full ${n&&i?"bg-gradient-to-r from-purple-500 to-violet-500 text-white":"bg-slate-100 dark:bg-slate-700"}`,children:[e.jsx(N,{size:14,className:n&&i?"text-white":"text-yellow-500"}),e.jsx("span",{className:`font-bold ${n&&i?"text-white":"text-slate-900 dark:text-white"}`,children:t.price.toLocaleString()})]})]}),n&&i&&t.original_price&&e.jsxs("div",{className:"text-xs font-semibold text-purple-600 dark:text-purple-400",children:["Save ",(t.original_price-t.price).toLocaleString()," points!"]}),c>0&&e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:["+ ",c.toLocaleString()," tax (",l,"%) = ",e.jsxs("span",{className:"font-semibold",children:[p.toLocaleString()," total"]})]}),n&&i&&w>0&&e.jsxs("div",{className:"flex items-center justify-center gap-1 text-xs text-purple-600 dark:text-purple-400 font-medium",children:[e.jsx(V,{size:12}),e.jsxs("span",{children:["Sale ends in ",w," ",w===1?"day":"days"]})]})]})]}),t.stock>0&&t.stock<10&&!t.owned&&e.jsxs("div",{className:"text-center text-xs text-orange-600 dark:text-orange-400 mb-3",children:["Only ",t.stock," left!"]}),e.jsx("button",{onClick:()=>M(t.id,p),disabled:t.owned||!u||x||j===t.id,className:`w-full px-4 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base ${t.owned?"bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-400 cursor-not-allowed":x?"bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-500 cursor-not-allowed":u?j===t.id?"bg-purple-400 text-white cursor-wait":n&&i?"bg-gradient-to-r from-purple-500 to-violet-500 hover:from-purple-600 hover:to-violet-600 text-white":"bg-purple-500 hover:bg-purple-600 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-500 cursor-not-allowed"}`,children:t.owned?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(T,{size:16}),"Owned"]}):x?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(A,{size:16}),"Out of Stock"]}):u?j===t.id?"Purchasing...":"Purchase":e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(A,{size:16}),"Not Enough Points"]})})]},t.id)})})]})}export{ne as default};
