import{u as L,r as i,s as o,j as e,M as S,X as U}from"./index-2dP_p1EG.js";import{A as W}from"./arrow-left-Dt9LD_ZK.js";import{P as T}from"./pin-BrWY5Ew-.js";import{C as E}from"./clock-DJOLL9Lo.js";import{E as P}from"./eye-BXeyh3Pv.js";import{S as G}from"./send-CguWdOWq.js";import{P as J}from"./plus-BwuWPFcm.js";function K(){const{user:m}=L(),[q,D]=i.useState([]),[b,w]=i.useState([]),[u,j]=i.useState([]),[l,N]=i.useState(null),[a,p]=i.useState(null),[R,g]=i.useState(!1),[F,h]=i.useState(!0),[k,v]=i.useState(""),[c,y]=i.useState({title:"",content:""});i.useEffect(()=>{A()},[]),i.useEffect(()=>{l&&!a&&_(l)},[l,a]),i.useEffect(()=>{a&&(C(a.id),M(a.id))},[a]);const A=async()=>{var r;h(!0);try{const{data:t,error:n}=await o.from("forum_categories").select("*").order("order_index",{ascending:!0});if(n)throw n;const s=[{id:"craft",name:"Poetry Craft",description:"Discuss techniques, forms, and writing methods",icon:"âœï¸",order_index:1},{id:"feedback",name:"Feedback & Critique",description:"Get constructive feedback on your work",icon:"ðŸ’¬",order_index:2},{id:"inspiration",name:"Inspiration & Prompts",description:"Share ideas and writing prompts",icon:"ðŸ’¡",order_index:3},{id:"general",name:"General Discussion",description:"Talk about poetry and related topics",icon:"ðŸ—¨ï¸",order_index:4}];D(t&&t.length>0?t:s),(t&&t.length>0||s.length>0)&&N(t&&((r=t[0])==null?void 0:r.id)||s[0].id)}catch(t){console.error("Error loading categories:",t)}finally{h(!1)}},_=async r=>{h(!0);try{const{data:t,error:n}=await o.from("forum_topics").select("*").eq("category_id",r).order("is_pinned",{ascending:!1}).order("last_activity_at",{ascending:!1}).limit(20);if(n)throw n;const s=await Promise.all((t||[]).map(async x=>{const{data:d}=await o.from("user_profiles").select("username").eq("user_id",x.user_id).maybeSingle();return{...x,username:(d==null?void 0:d.username)||"Anonymous"}}));w(s)}catch(t){console.error("Error loading topics:",t),w([])}finally{h(!1)}},C=async r=>{try{const{data:t,error:n}=await o.from("forum_replies").select("*").eq("topic_id",r).order("created_at",{ascending:!0});if(n)throw n;const s=await Promise.all((t||[]).map(async x=>{const{data:d}=await o.from("user_profiles").select("username").eq("user_id",x.user_id).maybeSingle();return{...x,username:(d==null?void 0:d.username)||"Anonymous"}}));j(s)}catch(t){console.error("Error loading replies:",t),j([])}},M=async r=>{try{await o.rpc("increment_topic_views",{topic_id:r})}catch(t){console.error("Error incrementing view count:",t)}},B=async r=>{if(r.preventDefault(),!m){alert("Please sign in to create a topic");return}try{const{error:t}=await o.from("forum_topics").insert({category_id:l,title:c.title,content:c.content,user_id:m.id,is_pinned:!1,reply_count:0,view_count:0});if(t)throw t;g(!1),y({title:"",content:""}),l&&_(l)}catch(t){console.error("Error creating topic:",t),alert("Failed to create topic. Please try again.")}},I=async r=>{if(r.preventDefault(),!(!m||!a))try{const{error:t}=await o.from("forum_replies").insert({topic_id:a.id,content:k,user_id:m.id});if(t)throw t;await o.from("forum_topics").update({reply_count:(a.reply_count||0)+1,last_activity_at:new Date().toISOString()}).eq("id",a.id),v(""),C(a.id)}catch(t){console.error("Error posting reply:",t),alert("Failed to post reply. Please try again.")}},f=r=>{const t=new Date(r),s=Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60));return s<1?"Just now":s<24?`${s}h ago`:s<48?"Yesterday":t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})};return a?e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("button",{onClick:()=>p(null),className:"flex items-center gap-2 text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 mb-6 font-medium",children:[e.jsx(W,{className:"w-5 h-5"}),"Back to Topics"]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-6",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[a.is_pinned&&e.jsx(T,{className:"w-5 h-5 text-emerald-600 dark:text-emerald-400 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:a.title}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{children:["by ",a.username]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(E,{className:"w-4 h-4"}),f(a.created_at)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(P,{className:"w-4 h-4"}),a.view_count," views"]})]})]})]}),e.jsx("div",{className:"prose dark:prose-invert max-w-none",children:e.jsx("p",{className:"text-gray-700 dark:text-gray-300 whitespace-pre-wrap",children:a.content})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white mb-4",children:["Replies (",u.length,")"]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[u.map(r=>e.jsxs("div",{className:"border-l-2 border-emerald-600 dark:border-emerald-400 pl-4 py-2",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 text-sm",children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-white",children:r.username}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:f(r.created_at)})]}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 whitespace-pre-wrap",children:r.content})]},r.id)),u.length===0&&e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:"No replies yet. Be the first to respond!"})]}),m&&e.jsxs("form",{onSubmit:I,className:"mt-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Post a Reply"}),e.jsx("textarea",{value:k,onChange:r=>v(r.target.value),placeholder:"Share your thoughts...",rows:4,required:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent"}),e.jsxs("button",{type:"submit",className:"mt-3 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4"}),"Post Reply"]})]})]})]}):e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{className:"w-8 h-8 text-emerald-600 dark:text-emerald-400"}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Discussion Forums"})]}),e.jsxs("button",{onClick:()=>g(!0),className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5"}),"New Topic"]})]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"Join discussions about poetry, share insights, and connect with the community."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsx("div",{className:"lg:col-span-1 space-y-2",children:q.map(r=>e.jsx("button",{onClick:()=>{N(r.id),p(null)},className:`w-full text-left p-4 rounded-lg transition-colors ${l===r.id?"bg-emerald-50 dark:bg-emerald-900/20 border-2 border-emerald-600":"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-emerald-400"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-2xl",children:r.icon}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white truncate",children:r.name}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 line-clamp-1",children:r.description})]})]})},r.id))}),e.jsx("div",{className:"lg:col-span-3",children:F?e.jsx("div",{className:"text-center py-12",children:e.jsx("div",{className:"inline-block w-8 h-8 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"})}):e.jsx("div",{className:"space-y-3",children:b.length===0?e.jsx("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700",children:"No topics yet. Be the first to start a discussion!"}):b.map(r=>e.jsx("div",{onClick:()=>p(r),className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 hover:border-emerald-400 dark:hover:border-emerald-600 transition-colors cursor-pointer",children:e.jsxs("div",{className:"flex items-start gap-3",children:[r.is_pinned&&e.jsx(T,{className:"w-5 h-5 text-emerald-600 dark:text-emerald-400 flex-shrink-0 mt-1"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white mb-2",children:r.title}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-2",children:r.content}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{children:["by ",r.username]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(S,{className:"w-3 h-3"}),r.reply_count||0]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(P,{className:"w-3 h-3"}),r.view_count||0]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(E,{className:"w-3 h-3"}),f(r.last_activity_at||r.created_at)]})]})]})]})]})},r.id))})})]}),R&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Create New Topic"}),e.jsx("button",{onClick:()=>g(!1),className:"text-gray-500 hover:text-gray-700 dark:hover:text-gray-300",children:e.jsx(U,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:B,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Topic Title"}),e.jsx("input",{type:"text",required:!0,value:c.title,onChange:r=>y({...c,title:r.target.value}),placeholder:"What would you like to discuss?",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Content"}),e.jsx("textarea",{required:!0,value:c.content,onChange:r=>y({...c,content:r.target.value}),placeholder:"Share your thoughts, questions, or ideas...",rows:8,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>g(!1),className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors",children:"Create Topic"})]})]})]})})]})}export{K as default};
